#!/usr/bin/env python3

from datetime import datetime
import json
import os.path

def main():
    datetime_now = datetime.today()
    filepath = '/home/cowrie/cowrie/var/log/cowrie/cowrie.json'
    is_exist = os.path.exists(filepath)
    if is_exist:
        with open(filepath) as f:
            for line in f:
                data = json.loads(line)
                delta = count_delta(datetime_now, data['timestamp'])
                # attempt in 10 seconds
                if delta > 0 and delta <= 15 and 'cowrie.login' in data['eventid']:
                    if not os.path.exists('/home/cowrie/modules/malware_detector/data'):
                        os.mkdir('/home/cowrie/modules/malware_detector/data')
                    if not os.path.exists('/home/cowrie/modules/malware_detector/data/' + data['src_ip']):
                        os.mkdir('/home/cowrie/modules/malware_detector/data/' + data['src_ip'])
                    filepath_ = '/home/cowrie/modules/malware_detector/data/' + data['src_ip'] + '/' + get_date_YYYYMMDD(data['timestamp'])
                    if not is_already_exist(data, filepath_):
                        with open(filepath_, 'a+') as f_:
                            inhalt = '{"timestamp": "' + data["timestamp"] + '", "username": "' + data["username"] + '", "password": "' + data["password"] + '", "eventid": "' + data["eventid"] + '"}'
                            f_.write(inhalt + '\n')
    # TODO add info -> login attempt / malicious activity detected
    #   1. if log.in.succeed in data[] -> malicious
    #   2. read data at day -> multiple log in attemps = malicious
    #   3. another based on command need research

def count_attempts(data, datetime_today):
    count = 0
    filepath = '/home/cowrie/modules/malware_detector/data/' + data["src_ip"] + '/' + get_date_YYYYMMDD(data["timestamp"]) 
    if os.path.exists(filepath):
        with open(filepath) as f:
            for line in f:
                delta = count_delta(datetime_today, f)
                if delta > 0 and delta < 10:
                    count += 1
    return count

def count_delta(datetime_now, date_time_item_str):
    date_time_item = datetime.strptime(date_time_item_str, '%Y-%m-%dT%H:%M:%S.%fZ')
    delta = int((datetime_now-date_time_item).total_seconds())
    return delta

def get_date_YYYYMMDD(date_time):
    end_pos = date_time.find('T')
    return date_time[0:end_pos:]

def is_already_exist(data, filepath):
    if os.path.exists(filepath):
        with open(filepath) as f:
            for line in f:
                tmp = json.loads(line)
                if tmp["username"] == data["username"] and tmp["password"] == data["password"]:
                    return True
    return False

if __name__ == '__main__':
    try:
        while True:
            try:
                main()
            except TypeError:
                continue
    except KeyboardInterrupt:
        print("\nMalware detector stopped")
